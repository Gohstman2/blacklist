<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLACKLIST - Suivi de Téléphones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ... (ton CSS existant reste inchangé) ... */

        /* Styles de loading améliorés */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        .button-loading {
            position: relative;
            color: transparent !important;
        }

        .button-loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            left: 50%;
            margin: -10px 0 0 -10px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        .overlay-loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .overlay-content {
            background: white;
            padding: 30px;
            border-radius: var(--border-radius);
            text-align: center;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <!-- ... (ton HTML existant reste inchangé) ... -->

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Références aux éléments DOM
            const repairBtn = document.getElementById('repair-btn');
            const repairModal = document.getElementById('repair-modal');
            const closeModal = document.querySelector('.close-modal');
            const loginForm = document.getElementById('repair-login-form');
            
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.step-content');
            const prevButtons = document.querySelectorAll('.btn-prev');
            const nextButtons = document.querySelectorAll('.btn-next');
            
            const imeiSearchInput = document.getElementById('imei-search');
            const searchBtn = document.getElementById('search-btn');
            const loader = document.getElementById('loader');
            const phoneInfo = document.getElementById('phone-info');
            const noResults = document.getElementById('no-results');
            const blacklistForm = document.getElementById('blacklist-form');
            const newSearchBtn = document.getElementById('new-search');
            
            let currentStep = 1;
            let currentImei = '';

            // Configuration de l'API
            const API_BASE_URL = 'https://sendfiles.pythonanywhere.com/api';

            // =============================================================
            // FONCTIONS DE GESTION DU LOADING
            // =============================================================

            function showButtonLoading(button) {
                button.classList.add('button-loading');
                button.disabled = true;
            }

            function hideButtonLoading(button) {
                button.classList.remove('button-loading');
                button.disabled = false;
            }

            function showGlobalLoading(message = 'Traitement en cours...') {
                const overlay = document.createElement('div');
                overlay.className = 'overlay-loading';
                overlay.innerHTML = `
                    <div class="overlay-content">
                        <div class="loader"></div>
                        <p style="margin-top: 20px; color: var(--dark-color);">${message}</p>
                    </div>
                `;
                overlay.id = 'global-loading';
                document.body.appendChild(overlay);
            }

            function hideGlobalLoading() {
                const overlay = document.getElementById('global-loading');
                if (overlay) {
                    overlay.remove();
                }
            }

            // =============================================================
            // FONCTIONS API
            // =============================================================

            async function makeApiRequest(endpoint, options = {}) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json',
                        },
                        ...options
                    });

                    if (!response.ok) {
                        throw new Error(`Erreur HTTP: ${response.status}`);
                    }

                    return await response.json();
                } catch (error) {
                    console.error('Erreur API:', error);
                    throw error;
                }
            }

            async function rechercheImei(imei) {
                return await makeApiRequest('/recherche_imei', {
                    method: 'POST',
                    body: JSON.stringify({ imei })
                });
            }

            async function ajouterBlacklist(data) {
                return await makeApiRequest('/blacklist', {
                    method: 'POST',
                    body: JSON.stringify(data)
                });
            }

            async function loginReparateur(email, password) {
                return await makeApiRequest('/login_reparateur', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            }

            async function getStats() {
                return await makeApiRequest('/stats', {
                    method: 'GET'
                });
            }

            async function getStorageInfo() {
                return await makeApiRequest('/storage', {
                    method: 'GET'
                });
            }

            async function generateUserId() {
                return await makeApiRequest('/generate_user_id', {
                    method: 'GET'
                });
            }

            // =============================================================
            // GESTION DES ÉVÉNEMENTS
            // =============================================================

            // Ouvrir le modal réparateurs
            repairBtn.addEventListener('click', function() {
                repairModal.style.display = 'flex';
            });

            // Fermer le modal réparateurs
            closeModal.addEventListener('click', function() {
                repairModal.style.display = 'none';
            });

            // Fermer le modal si on clique à l'extérieur
            window.addEventListener('click', function(e) {
                if (e.target === repairModal) {
                    repairModal.style.display = 'none';
                }
            });

            // Soumission du formulaire de connexion réparateurs
            loginForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('login-email').value;
                const password = document.getElementById('login-password').value;
                
                showButtonLoading(e.submitter);
                
                try {
                    const result = await loginReparateur(email, password);
                    if (result.success) {
                        showNotification('Connexion réussie!', 'success');
                        repairModal.style.display = 'none';
                        // Redirection ou autre action après connexion
                    } else {
                        showNotification(result.error || 'Erreur de connexion', 'error');
                    }
                } catch (error) {
                    showNotification('Erreur de connexion au serveur', 'error');
                } finally {
                    hideButtonLoading(e.submitter);
                }
            });

            // Navigation entre les étapes
            function updateSteps(stepNumber) {
                steps.forEach(step => {
                    if (parseInt(step.dataset.step) === stepNumber) {
                        step.classList.add('active');
                    } else if (parseInt(step.dataset.step) < stepNumber) {
                        step.classList.remove('active');
                        step.classList.add('completed');
                    } else {
                        step.classList.remove('active', 'completed');
                    }
                });

                stepContents.forEach(content => {
                    content.classList.remove('active');
                    if (content.id === `step-${stepNumber}`) {
                        content.classList.add('active');
                    }
                });

                currentStep = stepNumber;
            }

            // Boutons Précédent
            prevButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (currentStep > 1) {
                        updateSteps(currentStep - 1);
                    }
                });
            });

            // Boutons Suivant
            nextButtons.forEach(button => {
                button.addEventListener('click', function() {
                    if (currentStep < 4) {
                        updateSteps(currentStep + 1);
                    }
                });
            });

            // Événement de recherche
            searchBtn.addEventListener('click', async function() {
                const imei = imeiSearchInput.value.trim();
                
                if (imei.length !== 15 || isNaN(imei)) {
                    showNotification('Veuillez entrer un numéro IMEI valide (15 chiffres)', 'error');
                    return;
                }

                currentImei = imei;
                showButtonLoading(searchBtn);
                loader.classList.remove('hidden');
                phoneInfo.classList.add('hidden');
                noResults.classList.add('hidden');

                try {
                    const result = await rechercheImei(imei);
                    
                    if (result.trouve) {
                        // Afficher les informations du téléphone
                        phoneInfo.classList.remove('hidden');
                        
                        document.getElementById('phone-brand').textContent = result.marque || 'Non spécifié';
                        document.getElementById('phone-imei').textContent = result.imei;
                        document.getElementById('reporter-name').textContent = result.nom_personne || 'Non spécifié';
                        document.getElementById('phone-carrier').textContent = result.nom_telecom || 'Non spécifié';
                        document.getElementById('reporter-phone').textContent = result.numero || 'Non spécifié';
                        document.getElementById('reporter-cnib').textContent = result.cnib || 'Non spécifié';
                        document.getElementById('other-id').textContent = result.autre_piece || 'Aucune';
                        
                        showNotification('Téléphone trouvé dans notre base de données!', 'success');
                    } else {
                        // Afficher le formulaire BLACKLIST
                        noResults.classList.remove('hidden');
                        document.getElementById('imei').value = imei;
                        
                        showNotification('Aucune information trouvée pour cet IMEI.', 'info');
                    }
                    
                    updateSteps(2);
                } catch (error) {
                    showNotification('Erreur lors de la recherche', 'error');
                } finally {
                    hideButtonLoading(searchBtn);
                    loader.classList.add('hidden');
                }
            });

            // Soumission du formulaire BLACKLIST
            blacklistForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = {
                    imei: document.getElementById('imei').value,
                    marque: document.getElementById('brand').value,
                    nom_complet: document.getElementById('name').value,
                    numero_telephone: document.getElementById('phone').value,
                    cnib: document.getElementById('cnib').value,
                    autre_piece: document.getElementById('other-document').value || ''
                };

                showButtonLoading(e.submitter);

                try {
                    const result = await ajouterBlacklist(formData);
                    
                    if (result.success) {
                        updateSteps(4);
                        showNotification(result.message, 'success');
                    } else {
                        showNotification(result.error, 'error');
                    }
                } catch (error) {
                    showNotification('Erreur lors de l\'ajout à la blacklist', 'error');
                } finally {
                    hideButtonLoading(e.submitter);
                }
            });

            // Nouvelle recherche
            newSearchBtn.addEventListener('click', function() {
                imeiSearchInput.value = '';
                blacklistForm.reset();
                updateSteps(1);
            });

            // Fonction pour afficher les notifications
            function showNotification(message, type) {
                const notificationArea = document.getElementById('notification-area');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <i class="fas ${type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle'}"></i>
                    ${message}
                `;
                
                notificationArea.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 5000);
            }

            // Initialisation de l'ID utilisateur
            initUserID();
        });

        // =============================================================
        // GESTION DE L'ID UTILISATEUR (version corrigée)
        // =============================================================

        const API_BASE_URL = 'https://sendfiles.pythonanywhere.com/api';

        async function initUserID() {
            const USER_ID_KEY = 'blacklist_user_id';
            const USER_IP_KEY = 'blacklist_user_ip';
            
            const storedUserID = localStorage.getItem(USER_ID_KEY);
            const storedUserIP = localStorage.getItem(USER_IP_KEY);
            
            if (storedUserID && storedUserIP) {
                console.log('ID utilisateur trouvé:', storedUserID);
                return storedUserID;
            } else {
                return await fetchUserID();
            }
        }

        async function fetchUserID() {
            try {
                const response = await fetch(`${API_BASE_URL}/generate_user_id`);
                const data = await response.json();
                
                if (data.user_id) {
                    localStorage.setItem('blacklist_user_id', data.user_id);
                    localStorage.setItem('blacklist_user_ip', data.ip_client);
                    return data.user_id;
                }
            } catch (error) {
                console.error('Erreur génération ID:', error);
                const tempID = 'temp_' + Date.now();
                localStorage.setItem('blacklist_user_id', tempID);
                return tempID;
            }
        }

        function getUserID() {
            return localStorage.getItem('blacklist_user_id');
        }
    </script>
</body>
</html>
