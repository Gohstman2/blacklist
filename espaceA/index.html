<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - BLACKLIST</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/chart.js@4.5.0/dist/chart.umd.min.js" ></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #e74c3c;
            --accent-color: #3498db;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-color: #ecf0f1;
            --dark-color: #2c3e50;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        body {
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--primary-color);
            color: white;
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .sidebar-header {
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-header h2 {
            color: white;
            margin-bottom: 5px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 20px 0;
        }

        .sidebar-menu li {
            margin-bottom: 5px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 20px;
            color: #ddd;
            text-decoration: none;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }

        .sidebar-menu a:hover,
        .sidebar-menu a.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: var(--accent-color);
        }

        .sidebar-menu i {
            width: 25px;
            margin-right: 10px;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 250px;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .stat-label {
            color: #7f8c8d;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
        }

        .card-title {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin: 0;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: var(--light-color);
            font-weight: 600;
            color: var(--dark-color);
        }

        tr:hover {
            background: #f8f9fa;
        }

        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: var(--accent-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        .btn-sm {
            padding: 5px 10px;
            font-size: 0.8rem;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--accent-color);
            outline: none;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            width: 100%;
            max-width: 400px;
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        .notification {
            padding: 15px;
            margin: 10px 0;
            border-radius: var(--border-radius);
            font-weight: 600;
        }

        .success {
            background: rgba(46, 204, 113, 0.2);
            color: var(--success-color);
            border: 1px solid var(--success-color);
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            color: var(--danger-color);
            border: 1px solid var(--danger-color);
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Page de connexion -->
    <div id="login-page" class="login-container">
        <div class="login-card">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--primary-color);">
                <i class="fas fa-lock"></i> Admin BLACKLIST
            </h2>
            
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Nom d'utilisateur :</label>
                    <input type="text" id="username" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="password">Mot de passe :</label>
                    <input type="password" id="password" class="form-control" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 15px;">
                    Se connecter
                </button>
            </form>
            
            <div id="login-notification"></div>
        </div>
    </div>

    <!-- Dashboard Admin -->
    <div id="admin-dashboard" class="admin-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-shield-alt"></i> ADMIN</h2>
                <p>Panel de contr√¥le</p>
            </div>
            
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="active" data-tab="dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#recherche" data-tab="recherche"><i class="fas fa-search"></i> Recherche IMEI</a></li>
                <li><a href="#blacklist" data-tab="blacklist"><i class="fas fa-ban"></i> Blacklist</a></li>
                <li><a href="#reparateurs" data-tab="reparateurs"><i class="fas fa-tools"></i> R√©parateurs</a></li>
                <li><a href="#utilisateurs" data-tab="utilisateurs"><i class="fas fa-users"></i> Utilisateurs</a></li>
                <li><a href="#statistiques" data-tab="statistiques"><i class="fas fa-chart-bar"></i> Statistiques</a></li>
                <li><a href="#parametres" data-tab="parametres"><i class="fas fa-cog"></i> Param√®tres</a></li>
                <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> D√©connexion</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Panel d'Administration</h1>
                <div id="admin-info">
                    <span>Connect√© en tant que <strong>admin</strong></span>
                </div>
            </div>

            <!-- Contenu des diff√©rents onglets -->
            <div id="tab-content">
                <!-- Le contenu sera charg√© dynamiquement -->
                <div class="loading">
                    <div class="loader"></div>
                    <p>Chargement du dashboard...</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE_URL = 'https://sendfiles.pythonanywhere.com/api';
        let authToken = null;

        // =============================================================
        // FONCTIONS D'AUTHENTIFICATION
        // =============================================================

        document.getElementById('login-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const button = e.submitter;
            
            button.disabled = true;
            button.textContent = 'Connexion...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/admin/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    authToken = data.token;
                    localStorage.setItem('admin_token', authToken);
                    showAdminDashboard();
                } else {
                    showNotification('login-notification', data.error, 'error');
                }
            } catch (error) {
                showNotification('login-notification', 'Erreur de connexion', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'Se connecter';
            }
        });

        function showAdminDashboard() {
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('admin-dashboard').classList.remove('hidden');
            loadDashboard();
        }

        function checkAuth() {
            const token = localStorage.getItem('admin_token');
            if (token) {
                authToken = token;
                showAdminDashboard();
            }
        }

        // V√©rifier l'authentification au chargement
        checkAuth();

        // =============================================================
        // FONCTIONS DE GESTION DE L'INTERFACE
        // =============================================================

        function showNotification(containerId, message, type) {
            const container = document.getElementById(containerId);
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            container.innerHTML = '';
            container.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 5000);
        }

        async function loadDashboard() {
            const tabContent = document.getElementById('tab-content');
            tabContent.innerHTML = `
                <div class="loading">
                    <div class="loader"></div>
                    <p>Chargement des donn√©es...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/admin/stats`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                renderDashboard(data);
            } catch (error) {
                tabContent.innerHTML = `
                    <div class="notification error">
                        Erreur lors du chargement: ${error.message}
                    </div>
                `;
            }
        }

        function renderDashboard(stats) {
            const tabContent = document.getElementById('tab-content');
            
            tabContent.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">${stats.blacklist}</div>
                        <div class="stat-label">T√©l√©phones blacklist√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.unlocked}</div>
                        <div class="stat-label">T√©l√©phones flash√©s</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.reparateurs}</div>
                        <div class="stat-label">R√©parateurs</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${stats.retrouves}</div>
                        <div class="stat-label">T√©l√©phones retrouv√©s</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Statistiques mensuelles</h3>
                    </div>
                    <div class="chart-container">
                        <canvas id="monthlyChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Top R√©parateurs</h3>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Nom</th>
                                    <th>T√©l√©phones flash√©s</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${stats.top_reparateurs.map(rep => `
                                    <tr>
                                        <td>${rep.nom_complet}</td>
                                        <td>${rep.telephones_flashes}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            // Initialiser les graphiques
            initCharts(stats);
        }

        function initCharts(stats) {
            // Graphique mensuel
            const monthlyCtx = document.getElementById('monthlyChart').getContext('2d');
            new Chart(monthlyCtx, {
                type: 'bar',
                data: {
                    labels: stats.stats_mois.map(s => s.mois),
                    datasets: [{
                        label: 'Signalements par mois',
                        data: stats.stats_mois.map(s => s.nombre),
                        backgroundColor: '#3498db'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // =============================================================
        // GESTIONNAIRES D'√âV√âNEMENTS
        // =============================================================

        // Navigation dans le sidebar
        document.querySelectorAll('.sidebar-menu a[data-tab]').forEach(link => {
            link.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Mettre √† jour la classe active
                document.querySelectorAll('.sidebar-menu a').forEach(a => {
                    a.classList.remove('active');
                });
                this.classList.add('active');
                
                const tab = this.getAttribute('data-tab');
                loadTab(tab);
            });
        });

        // D√©connexion
        document.getElementById('logout-btn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('admin_token');
            authToken = null;
            document.getElementById('admin-dashboard').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
        });

        // =============================================================
        // CHARGEMENT DES ONGLETS
        // =============================================================

        async function loadTab(tabName) {
            const tabContent = document.getElementById('tab-content');
            tabContent.innerHTML = `
                <div class="loading">
                    <div class="loader"></div>
                    <p>Chargement...</p>
                </div>
            `;

            try {
                switch(tabName) {
                    case 'dashboard':
                        await loadDashboard();
                        break;
                    case 'recherche':
                        loadRechercheTab();
                        break;
                    case 'blacklist':
                        loadBlacklistTab();
                        break;
                    case 'reparateurs':
                        loadReparateursTab();
                        break;
                    // ... autres onglets
                    default:
                        tabContent.innerHTML = `<div class="notification info">Onglet en d√©veloppement</div>`;
                }
            } catch (error) {
                tabContent.innerHTML = `
                    <div class="notification error">
                        Erreur: ${error.message}
                    </div>
                `;
            }
        }

        function loadRechercheTab() {
            const tabContent = document.getElementById('tab-content');
            tabContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Recherche avanc√©e IMEI</h3>
                    </div>
                    <div class="form-group">
                        <input type="text" id="imei-search" class="form-control" placeholder="Entrez l'IMEI (15 chiffres)" maxlength="15">
                    </div>
                    <button onclick="searchImei()" class="btn btn-primary">
                        <i class="fas fa-search"></i> Rechercher
                    </button>
                    <div id="search-results" style="margin-top: 20px;"></div>
                </div>
            `;
        }

        async function searchImei() {
            const imei = document.getElementById('imei-search').value;
            const resultsContainer = document.getElementById('search-results');
            
            if (imei.length !== 15) {
                resultsContainer.innerHTML = `
                    <div class="notification error">IMEI invalide (15 chiffres requis)</div>
                `;
                return;
            }

            resultsContainer.innerHTML = `
                <div class="loading">
                    <div class="loader"></div>
                    <p>Recherche en cours...</p>
                </div>
            `;

            try {
                const response = await fetch(`${API_BASE_URL}/admin/search_imei`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ imei })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                let html = '<div class="card">';
                html += '<h4>R√©sultats pour IMEI: ' + imei + '</h4>';
                
                if (data.blacklist) {
                    html += `
                        <h5>üì± Blacklist√©</h5>
                        <p><strong>Marque:</strong> ${data.blacklist.marque}</p>
                        <p><strong>Propri√©taire:</strong> ${data.blacklist.nom_complet}</p>
                        <p><strong>CNIB:</strong> ${data.blacklist.cnib}</p>
                        <p><strong>Date signalement:</strong> ${new Date(data.blacklist.date_signalement).toLocaleDateString()}</p>
                    `;
                }
                
                if (data.unlocked) {
                    html += `
                        <h5>üîß Flash√© par un r√©parateur</h5>
                        <p><strong>Marque:</strong> ${data.unlocked.marque}</p>
                        <p><strong>Personne:</strong> ${data.unlocked.nom_personne}</p>
                        <p><strong>R√©parateur:</strong> ${data.unlocked.nom_reparateur}</p>
                        <p><strong>Contact r√©parateur:</strong> ${data.unlocked.email_reparateur}</p>
                        <p><strong>Date flash:</strong> ${new Date(data.unlocked.date_ajout).toLocaleDateString()}</p>
                    `;
                }
                
                if (!data.blacklist && !data.unlocked) {
                    html += '<p>Aucune information trouv√©e pour cet IMEI</p>';
                }
                
                html += '</div>';
                resultsContainer.innerHTML = html;
                
            } catch (error) {
                resultsContainer.innerHTML = `
                    <div class="notification error">Erreur: ${error.message}</div>
                `;
            }
        }

        // Charger le dashboard par d√©faut
        if (authToken) {
            loadDashboard();
        } 
        // =============================================================
// FONCTIONS POUR L'ONGLET BLACKLIST
// =============================================================

function loadBlacklistTab() {
    const tabContent = document.getElementById('tab-content');
    if (!tabContent) return;
    
    tabContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Gestion de la Blacklist</h3>
                <button onclick="loadBlacklistData()" class="btn btn-primary">
                    <i class="fas fa-sync"></i> Actualiser
                </button>
            </div>
            <div id="blacklist-content">
                <div class="loading">
                    <div class="loader"></div>
                    <p>Chargement de la blacklist...</p>
                </div>
            </div>
        </div>
    `;
    
    loadBlacklistData();
}

async function loadBlacklistData() {
    const content = document.getElementById('blacklist-content');
    if (!content) return;
    
    content.innerHTML = `
        <div class="loading">
            <div class="loader"></div>
            <p>Chargement des donn√©es...</p>
        </div>
    `;

    try {
        const response = await fetch(`${API_BASE_URL}/admin/blacklist`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
            throw new Error(data.error);
        }

        if (!data.blacklist || data.blacklist.length === 0) {
            content.innerHTML = '<p class="notification info">Aucun t√©l√©phone dans la blacklist</p>';
            return;
        }

        let html = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>IMEI</th>
                            <th>Marque</th>
                            <th>Propri√©taire</th>
                            <th>T√©l√©phone</th>
                            <th>CNIB</th>
                            <th>Date signalement</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;

        data.blacklist.forEach(phone => {
            html += `
                <tr>
                    <td>${phone.imei || 'N/A'}</td>
                    <td>${phone.marque || 'N/A'}</td>
                    <td>${phone.nom_complet || 'N/A'}</td>
                    <td>${phone.numero_telephone || 'N/A'}</td>
                    <td>${phone.cnib || 'N/A'}</td>
                    <td>${phone.date_signalement ? new Date(phone.date_signalement).toLocaleDateString() : 'N/A'}</td>
                    <td>
                        <button onclick="markAsRecovered('${phone.imei}')" class="btn btn-success btn-sm">
                            <i class="fas fa-check"></i> Retrouv√©
                        </button>
                        <button onclick="deleteFromBlacklist('${phone.imei}')" class="btn btn-danger btn-sm">
                            <i class="fas fa-trash"></i> Supprimer
                        </button>
                    </td>
                </tr>
            `;
        });

        html += `
                    </tbody>
                </table>
            </div>
            <p class="text-muted">Total: ${data.blacklist.length} t√©l√©phones</p>
        `;

        content.innerHTML = html;

    } catch (error) {
        console.error('Erreur blacklist:', error);
        content.innerHTML = `
            <div class="notification error">
                Erreur: ${error.message}
            </div>
        `;
    }
}
// =============================================================
// FONCTIONS POUR CR√âER UN NOUVEAU R√âPARATEUR
// =============================================================

function loadReparateursTab() {
    const tabContent = document.getElementById('tab-content');
    if (!tabContent) return;
    
    tabContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Gestion des R√©parateurs</h3>
                <div>
                    <button onclick="loadReparateursData()" class="btn btn-primary">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                    <button onclick="showCreateReparateurForm()" class="btn btn-success">
                        <i class="fas fa-plus"></i> Nouveau R√©parateur
                    </button>
                </div>
            </div>
            <div id="reparateurs-content">
                <div class="loading">
                    <div class="loader"></div>
                    <p>Chargement des r√©parateurs...</p>
                </div>
            </div>
        </div>
        
        <!-- Modal pour cr√©er un r√©parateur -->
        <div id="create-reparateur-modal" class="modal hidden">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close-modal" onclick="hideCreateReparateurForm()">&times;</span>
                <h3 class="modal-title"><i class="fas fa-user-plus"></i> Cr√©er un Nouveau R√©parateur</h3>
                <form id="create-reparateur-form" onsubmit="createReparateur(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label for="new-nom-complet">Nom complet *</label>
                            <input type="text" id="new-nom-complet" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-cnib">CNIB *</label>
                            <input type="text" id="new-cnib" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-telephone">Num√©ro de t√©l√©phone *</label>
                            <input type="text" id="new-telephone" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-telecom">Op√©rateur t√©l√©com *</label>
                            <select id="new-telecom" class="form-control" required>
                                <option value="">S√©lectionner</option>
                                <option value="Orange">Orange</option>
                                <option value="MTN">MTN</option>
                                <option value="Moov">Moov</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="new-email">Email *</label>
                            <input type="email" id="new-email" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label for="new-password">Mot de passe *</label>
                            <input type="password" id="new-password" class="form-control" required minlength="6">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="admin-key">Cl√© administrateur *</label>
                        <input type="password" id="admin-key" class="form-control" required 
                               placeholder="Cl√© secr√®te pour autoriser la cr√©ation">
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-secondary" onclick="hideCreateReparateurForm()">
                            Annuler
                        </button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Cr√©er le R√©parateur
                        </button>
                    </div>
                </form>
            </div>
        </div>
    `;
    
    loadReparateursData();
}

function showCreateReparateurForm() {
    const modal = document.getElementById('create-reparateur-modal');
    if (modal) {
        modal.classList.remove('hidden');
        // Reset du formulaire
        document.getElementById('create-reparateur-form').reset();
    }
}

function hideCreateReparateurForm() {
    const modal = document.getElementById('create-reparateur-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

async function createReparateur(event) {
    event.preventDefault();
    
    const form = event.target;
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.innerHTML;
    
    // R√©cup√©rer les valeurs du formulaire
    const reparateurData = {
        nom_complet: document.getElementById('new-nom-complet').value,
        cnib: document.getElementById('new-cnib').value,
        numero_telephone: document.getElementById('new-telephone').value,
        nom_telecom: document.getElementById('new-telecom').value,
        email: document.getElementById('new-email').value,
        mot_de_passe: document.getElementById('new-password').value,
        admin_key: document.getElementById('admin-key').value
    };
    
    // Validation basique
    if (!reparateurData.admin_key) {
        showNotification('reparateurs-content', 'La cl√© administrateur est requise', 'error');
        return;
    }
    
    // Afficher le loading
    submitButton.disabled = true;
    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cr√©ation...';
    
    try {
        const response = await fetch(`${API_BASE_URL}/create_reparateur`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${authToken}`
            },
            body: JSON.stringify(reparateurData)
        });
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('reparateurs-content', 'R√©parateur cr√©√© avec succ√®s !', 'success');
            hideCreateReparateurForm();
            loadReparateursData(); // Recharger la liste
            
            // Afficher l'ID unique g√©n√©r√©
            if (data.id_unique) {
                setTimeout(() => {
                    alert(`R√©parateur cr√©√© avec succ√®s !\nID Unique: ${data.id_unique}\n\nNotez cet ID pour le r√©parateur.`);
                }, 500);
            }
        } else {
            throw new Error(data.error || 'Erreur lors de la cr√©ation');
        }
        
    } catch (error) {
        console.error('Erreur cr√©ation r√©parateur:', error);
        showNotification('reparateurs-content', 'Erreur: ' + error.message, 'error');
    } finally {
        // Restaurer le bouton
        submitButton.disabled = false;
        submitButton.innerHTML = originalText;
    }
}

// =============================================================
// FONCTIONS DE GESTION SUPPL√âMENTAIRES POUR R√âPARATEURS
// =============================================================

async function viewReparateurDetails(id) {
    try {
        const response = await fetch(`${API_BASE_URL}/admin/reparateur/${id}`, {
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            showReparateurDetailsModal(data.reparateur);
        } else {
            throw new Error('R√©parateur non trouv√©');
        }
    } catch (error) {
        showNotification('reparateurs-content', 'Erreur: ' + error.message, 'error');
    }
}

function showReparateurDetailsModal(reparateur) {
    const modalContent = `
        <div class="modal-content" style="max-width: 500px;">
            <span class="close-modal" onclick="hideModal()">&times;</span>
            <h3 class="modal-title">D√©tails du R√©parateur</h3>
            
            <div style="margin: 20px 0;">
                <div class="detail-item">
                    <strong>Nom complet:</strong> ${reparateur.nom_complet || 'N/A'}
                </div>
                <div class="detail-item">
                    <strong>Email:</strong> ${reparateur.email || 'N/A'}
                </div>
                <div class="detail-item">
                    <strong>T√©l√©phone:</strong> ${reparateur.numero_telephone || 'N/A'}
                </div>
                <div class="detail-item">
                    <strong>CNIB:</strong> ${reparateur.cnib || 'N/A'}
                </div>
                <div class="detail-item">
                    <strong>Op√©rateur:</strong> ${reparateur.nom_telecom || 'N/A'}
                </div>
                <div class="detail-item">
                    <strong>T√©l√©phones flash√©s:</strong> ${reparateur.nombre_telephones_flashes || 0}
                </div>
                <div class="detail-item">
                    <strong>Date d'inscription:</strong> ${reparateur.date_inscription ? new Date(reparateur.date_inscription).toLocaleDateString() : 'N/A'}
                </div>
                ${reparateur.id_unique ? `
                <div class="detail-item">
                    <strong>ID Unique:</strong> <code>${reparateur.id_unique}</code>
                </div>
                ` : ''}
            </div>
            
            <div style="display: flex; gap: 10px;">
                <button onclick="resetReparateurPassword(${reparateur.id})" class="btn btn-warning">
                    <i class="fas fa-key"></i> R√©init. MDP
                </button>
                <button onclick="blockReparateur(${reparateur.id})" class="btn btn-danger">
                    <i class="fas fa-ban"></i> Bloquer
                </button>
            </div>
        </div>
    `;
    
    showModal(modalContent);
}

async function resetReparateurPassword(id) {
    if (!confirm('R√©initialiser le mot de passe de ce r√©parateur ?\n\nUn nouveau mot de passe al√©atoire sera g√©n√©r√©.')) return;
    
    try {
        const response = await fetch(`${API_BASE_URL}/admin/reset_reparateur_password/${id}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('reparateurs-content', 'Mot de passe r√©initialis√© avec succ√®s', 'success');
            if (data.new_password) {
                alert(`Nouveau mot de passe: ${data.new_password}\n\nCommuniquez-le au r√©parateur.`);
            }
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        showNotification('reparateurs-content', 'Erreur: ' + error.message, 'error');
    }
}

// =============================================================
// FONCTIONS MODAL G√âN√âRIQUES
// =============================================================

function showModal(content) {
    let modal = document.getElementById('custom-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'custom-modal';
        modal.className = 'modal';
        document.body.appendChild(modal);
    }
    
    modal.innerHTML = content;
    modal.classList.remove('hidden');
}

function hideModal() {
    const modal = document.getElementById('custom-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// =============================================================
// STYLE CSS POUR LES D√âTAILS
// =============================================================

const detailStyle = `
    .detail-item {
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .detail-item:last-child {
        border-bottom: none;
    }
    .detail-item strong {
        display: inline-block;
        width: 150px;
        color: var(--dark-color);
    }
`;

// Ajouter le style
const styleSheet = document.createElement('style');
styleSheet.textContent = detailStyle;
document.head.appendChild(styleSheet);

// =============================================================
// EXPOSER LES NOUVELLES FONCTIONS GLOBALEMENT
// =============================================================

window.showCreateReparateurForm = showCreateReparateurForm;
window.hideCreateReparateurForm = hideCreateReparateurForm;
window.createReparateur = createReparateur;
window.viewReparateurDetails = viewReparateurDetails;
window.resetReparateurPassword = resetReparateurPassword;
window.hideModal = hideModal;
windows.loadReparateursTab = loadReparateursTab;



        
// =============================================================
// FONCTIONS POUR L'ONGLET UTILISATEURS
// =============================================================

function loadUtilisateursTab() {
    const tabContent = document.getElementById('tab-content');
    if (!tabContent) return;
    
    tabContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Gestion des Utilisateurs</h3>
            </div>
            <div class="notification info">
                Module utilisateurs en cours de d√©veloppement
            </div>
        </div>
    `;
}

// =============================================================
// FONCTIONS POUR L'ONGLET STATISTIQUES
// =============================================================

function loadStatistiquesTab() {
    const tabContent = document.getElementById('tab-content');
    if (!tabContent) return;
    
    tabContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Statistiques Avanc√©es</h3>
            </div>
            <div class="notification info">
                Module statistiques avanc√©es en cours de d√©veloppement
            </div>
        </div>
    `;
}

// =============================================================
// FONCTIONS POUR L'ONGLET PARAM√àTRES
// =============================================================

function loadParametresTab() {
    const tabContent = document.getElementById('tab-content');
    if (!tabContent) return;
    
    tabContent.innerHTML = `
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">Param√®tres Syst√®me</h3>
            </div>
            <div class="notification info">
                Module param√®tres en cours de d√©veloppement
            </div>
        </div>
    `;
}

// =============================================================
// FONCTIONS D'ACTION
// =============================================================

async function markAsRecovered(imei) {
    if (!confirm('Marquer ce t√©l√©phone comme retrouv√© ?')) return;

    try {
        const response = await fetch(`${API_BASE_URL}/admin/mark_recovered/${imei}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('blacklist-content', data.message, 'success');
            loadBlacklistData();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        console.error('Erreur marquage retrouv√©:', error);
        showNotification('blacklist-content', 'Erreur: ' + error.message, 'error');
    }
}

async function deleteFromBlacklist(imei) {
    if (!confirm('Supprimer d√©finitivement ce t√©l√©phone de la blacklist ?')) return;

    try {
        const response = await fetch(`${API_BASE_URL}/admin/delete_blacklist/${imei}`, {
            method: 'DELETE',
            headers: {
                'Authorization': `Bearer ${authToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error(`Erreur HTTP: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.success) {
            showNotification('blacklist-content', data.message, 'success');
            loadBlacklistData();
        } else {
            throw new Error(data.error);
        }
    } catch (error) {
        console.error('Erreur suppression:', error);
        showNotification('blacklist-content', 'Erreur: ' + error.message, 'error');
    }
}

async function blockReparateur(id) {
    if (!confirm('Bloquer ce r√©parateur ?')) return;
    
    try {
        showNotification('reparateurs-content', 'Tentative de blocage...', 'info');
        
        // Simuler une requ√™te (√† remplacer par votre endpoint r√©el)
        setTimeout(() => {
            showNotification('reparateurs-content', 'R√©parateur bloqu√© avec succ√®s', 'success');
            loadReparateursData();
        }, 1000);
        
    } catch (error) {
        showNotification('reparateurs-content', 'Erreur: ' + error.message, 'error');
    }
}

async function viewReparateur(id) {
    alert(`Voir les d√©tails du r√©parateur ID: ${id}\n\nCette fonctionnalit√© sera impl√©ment√©e prochainement.`);
}

// =============================================================
// FONCTION PRINCIPALE DE CHARGEMENT DES ONGLETS
// =============================================================

async function loadTab(tabName) {
    const tabContent = document.getElementById('tab-content');
    if (!tabContent) return;
    
    tabContent.innerHTML = `
        <div class="loading">
            <div class="loader"></div>
            <p>Chargement...</p>
        </div>
    `;

    try {
        switch(tabName) {
            case 'dashboard':
                await loadDashboard();
                break;
            case 'recherche':
                loadRechercheTab();
                break;
            case 'blacklist':
                loadBlacklistTab();
                break;
            case 'reparateurs':
                loadReparateursTab();
                break;
            case 'utilisateurs':
                loadUtilisateursTab();
                break;
            case 'statistiques':
                loadStatistiquesTab();
                break;
            case 'parametres':
                loadParametresTab();
                break;
            default:
                tabContent.innerHTML = `<div class="notification info">Onglet non reconnu</div>`;
        }
    } catch (error) {
        console.error('Erreur chargement onglet:', error);
        tabContent.innerHTML = `
            <div class="notification error">
                Erreur: ${error.message}
            </div>
        `;
    }
}

// =============================================================
// EXPOSER LES FONCTIONS GLOBALEMENT
// =============================================================

window.loadBlacklistData = loadBlacklistData;
window.loadReparateursData = loadReparateursData;
window.markAsRecovered = markAsRecovered;
window.deleteFromBlacklist = deleteFromBlacklist;
window.blockReparateur = blockReparateur;
window.viewReparateur = viewReparateur;
    </script>
</body>
</html>
