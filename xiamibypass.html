<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Testeur GetApps — Intent &amp; URI schemes</title>
  <style>
    :root{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial;}
    body{max-width:980px;margin:24px auto;padding:16px;line-height:1.4;color:#0b1220}
    h1{font-size:1.6rem;margin-bottom:0.2rem}
    p.lead{color:#374151}
    .card{border:1px solid #e6e9ef;padding:14px;border-radius:12px;box-shadow:0 6px 18px rgba(9,10,26,0.03);margin:12px 0}
    label{display:block;margin-top:8px;font-weight:600}
    input[type="text"]{width:100%;padding:8px;border-radius:8px;border:1px solid #d6d9e6}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    button{padding:10px 12px;border-radius:10px;border:0;background:#0f1724;color:#fff;cursor:pointer}
    small{color:#6b7280}
    .log{font-family:monospace;background:#0f1724;color:#fff;padding:10px;border-radius:8px;min-height:64px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media(max-width:700px){.grid{grid-template-columns:1fr}}
    a.inline{color:#0f1724;text-decoration:underline}
  </style>
</head>
<body>
  <h1>Testeur GetApps — Intent &amp; URI schemes</h1>
  <p class="lead">Page de test pour générer et essayer plusieurs combinaisons d'URI/intent qui peuvent ouvrir <strong>GetApps</strong> (ou d'autres stores) depuis un navigateur mobile.</p>

  <div class="card">
    <label for="pkg">Identifiant du package (ex: <code>com.whatsapp</code>)</label>
    <input id="pkg" type="text" value="com.whatsapp" />

    <label for="fallback">URL de fallback (optionnelle)</label>
    <input id="fallback" type="text" placeholder="https://play.google.com/store/apps/details?id=com.whatsapp" />

    <div class="row">
      <button id="btn_intent">Ouvrir (intent:// with package param)</button>
      <button id="btn_miapp">Ouvrir (miappstore://details)</button>
      <button id="btn_market">Ouvrir (market://details)</button>
      <button id="btn_generic">Ouvrir (market + intent fallback)</button>
      <button id="btn_try_all">Essayer toutes les combinaisons</button>
    </div>

    <p style="margin-top:10px"><small>Remarque: les résultats dépendent du navigateur mobile, de la version de MIUI/HyperOS et du fait que <strong>GetApps</strong> soit installé.</small></p>
  </div>

  <div class="card">
    <h3>Journal / Debug</h3>
    <div id="log" class="log">Prêt.</div>
  </div>

  <div class="card grid">
    <div>
      <h4>Comment ça marche (technique)</h4>
      <ul>
        <li>On construit différentes URIs: <code>intent://</code>, <code>miappstore://</code>, <code>market://</code>, etc.</li>
        <li>On tente d'ouvrir chaque URI en changeant <code>window.location</code> ou en créant un <code>iframe</code> (selon le navigateur).</li>
        <li>On tente de détecter l'ouverture via <code>visibilitychange</code> et un timeout: si la page devient cachée rapidement, l'intent a très probablement réussi.</li>
      </ul>
    </div>
    <div>
      <h4>Précautions</h4>
      <ul>
        <li>Les navigateurs modernes bloquent parfois les tentatives d'ouverture automatiques — utilisez les boutons manuellement si nécessaire.</li>
        <li>Ne cliquez pas trop vite sur "Essayer toutes" si votre navigateur bloque les pop-ups.</li>
      </ul>
    </div>
  </div>

  <script>
    const pkgInput = document.getElementById('pkg');
    const fallbackInput = document.getElementById('fallback');
    const logEl = document.getElementById('log');

    function log(...args){
      const time = new Date().toLocaleTimeString();
      logEl.textContent = time + ' — ' + args.join(' ') + '\n' + logEl.textContent;
    }

    function buildIntentLink(packageName, options = {}){
      const scheme = options.scheme || 'miappstore';
      const storePackage = options.storePackage || 'com.xiaomi.mipicks';
      const fallback = options.fallback;
      let intent = 'intent://details?id=' + encodeURIComponent(packageName) + '#Intent;scheme=' + scheme + ';package=' + storePackage + ';end';
      if(fallback){
        intent = 'intent://details?id=' + encodeURIComponent(packageName) + '#Intent;scheme=' + scheme + ';package=' + storePackage + ';S.browser_fallback_url=' + encodeURIComponent(fallback) + ';end';
      }
      return intent;
    }

    function openLink(href){
      log('Tentative d\'ouverture →', href);
      window.location.href = href;
    }

    function openViaIframe(href){
      log('Tentative via iframe →', href);
      const iframe = document.createElement('iframe');
      iframe.style.display = 'none';
      iframe.src = href;
      document.body.appendChild(iframe);
      setTimeout(()=>document.body.removeChild(iframe), 2000);
    }

    let openedDetected = false;
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){
        openedDetected = true;
        log('visibilitychange: la page est cachée — l\'app a probablement ouvert.');
      } else {
        log('visibilitychange: la page revenue visible.');
      }
    });

    function tryOpen(href){
      openedDetected = false;
      const start = Date.now();
      try {
        window.location.href = href;
      } catch(e){
        log('Erreur avec location.href — fallback to iframe');
        openViaIframe(href);
      }
      setTimeout(()=>{
        const took = Date.now() - start;
        if(openedDetected){
          log('Succès détecté (heuristique) —', took + 'ms');
        } else {
          log('Aucun changement visible détecté après', took + 'ms', '- L\'intent a peut-être échoué ou le navigateur a bloqué l\'action.');
        }
      }, 1200);
    }

    document.getElementById('btn_intent').addEventListener('click', ()=>{
      const pkg = pkgInput.value.trim();
      const fallback = fallbackInput.value.trim() || null;
      const href = buildIntentLink(pkg, {fallback});
      tryOpen(href);
    });

    document.getElementById('btn_miapp').addEventListener('click', ()=>{
      const pkg = pkgInput.value.trim();
      const href = 'miappstore://details?id=' + encodeURIComponent(pkg);
      tryOpen(href);
    });

    document.getElementById('btn_market').addEventListener('click', ()=>{
      const pkg = pkgInput.value.trim();
      const href = 'market://details?id=' + encodeURIComponent(pkg);
      tryOpen(href);
    });

    document.getElementById('btn_generic').addEventListener('click', ()=>{
      const pkg = pkgInput.value.trim();
      const fallback = fallbackInput.value.trim() || ('https://play.google.com/store/apps/details?id=' + encodeURIComponent(pkg));
      log('Strategy: market:// puis intent with browser_fallback_url');
      tryOpen('market://details?id=' + encodeURIComponent(pkg));
      setTimeout(()=>{
        const href = buildIntentLink(pkg, {fallback});
        tryOpen(href);
      }, 1500);
    });

    document.getElementById('btn_try_all').addEventListener('click', async ()=>{
      const pkg = pkgInput.value.trim();
      const fallback = fallbackInput.value.trim() || ('https://play.google.com/store/apps/details?id=' + encodeURIComponent(pkg));
      const combos = [
        {label: 'intent (miappstore + package com.xiaomi.mipicks)', href: buildIntentLink(pkg, {fallback})},
        {label: 'miappstore://details', href: 'miappstore://details?id=' + encodeURIComponent(pkg)},
        {label: 'market://details', href: 'market://details?id=' + encodeURIComponent(pkg)},
        {label: 'intent (scheme=mipicks)', href: 'intent://details?id=' + encodeURIComponent(pkg) + '#Intent;scheme=mipicks;package=com.xiaomi.mipicks;end'},
        {label: 'intent (without package)', href: 'intent://details?id=' + encodeURIComponent(pkg) + '#Intent;scheme=miappstore;end'},
        {label: 'https fallback', href: fallback}
      ];

      log('Début de la séquence —', combos.length, 'combinaisons');
      for(let i=0;i<combos.length;i++){
        log('('+(i+1)+'/'+combos.length+')', combos[i].label);
        tryOpen(combos[i].href);
        await new Promise(res=>setTimeout(res, 1600));
        if(document.hidden){
          log('La page est cachée — app ouverte, on attend le retour.');
          await new Promise(res=>setTimeout(res, 2000));
          break;
        }
      }
      log('Séquence terminée.');
    });

    log('User Agent:', navigator.userAgent);
  </script>
</body>
</html>
